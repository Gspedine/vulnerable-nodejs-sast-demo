name: CI/CD - P2 SAST Demo  # Nome descritivo para a entrega

on:  # Trigger em push/PR nas branches Gitflow
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  ci:  # Job CI com todas as etapas exigidas
    runs-on: ubuntu-latest
    steps:
      - name: Checkout  # Etapa: Baixa código
        uses: actions/checkout@v4

      - name: Install Node.js  # Prepara ambiente Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'  # Compatível com engines no package.json

      - name: Install Dependencies  # Etapa: Install deps
        run: npm ci

      - name: Run Tests  # Etapa: Executa testes
        run: npm test

      - name: Run Coverage  # Etapa: Gera cobertura mínima
        run: npm run test:coverage

      - name: SAST - SonarCloud Scan (Obrigatório)  # Etapa: SAST SonarCloud
        uses: SonarSource/sonarcloud-github-action@v2.3.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Automático
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}  # Seu token
        with:
          args: >
            -Dsonar.organization=thmn93  # Seu org real
            -Dsonar.projectKey=Thmn93_api-sast  # Seu projectKey real
        continue-on-error: true  # Não para o pipeline (requisito)

      - name: SAST - Snyk Scan (Diferencial)  # Etapa: SAST extra Snyk
        uses: snyk/actions/node@master
        continue-on-error: true  # Não para o pipeline
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}  # Seu token Snyk
        with:
          args: --severity-threshold=medium

      - name: Build  # Etapa: Build (placeholder para Node)
        run: echo "Build completo"

      - name: Semantic Versioning  # Etapa: Versionamento semântico (action atualizada)
        id: tag_version  # ID para outputs
        uses: mathieudutour/github-tag-action@v6.2  # Action mantida em 2025 para semver tags
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}  # Automático para tagging

      - name: Build Docker Image  # Etapa: Build imagem Docker
        run: docker build -t api-sast:${{ steps.tag_version.outputs.new_tag }} .  # Usa tag semântica (ex: v1.0.0)

  cd:  # Job CD (deploy após CI)
    needs: ci
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Login to Docker Hub  # Login para push
        uses: docker/login-action@v